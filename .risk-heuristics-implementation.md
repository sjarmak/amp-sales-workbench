# Risk Heuristics Implementation Summary

## Files Created

1. **[src/agents/riskHeuristics.ts](file:///Users/sjarmak/amp-sales-workbench/src/agents/riskHeuristics.ts)**
   - Main risk detection agent with 8 heuristic functions
   - Analyzes ConsolidatedSnapshot to detect deal risks
   - Outputs JSON and Markdown reports to `data/accounts/<slug>/reviews/`

2. **[scripts/test-risk-heuristics.ts](file:///Users/sjarmak/amp-sales-workbench/scripts/test-risk-heuristics.ts)**
   - CLI script for running risk analysis
   - Usage: `npm run risks "Account Name"`

## Files Modified

3. **[api-server.ts](file:///Users/sjarmak/amp-sales-workbench/api-server.ts)**
   - Added `GET /api/accounts/:slug/risks` endpoint
   - Added 'risk-heuristics' to agentScripts registry

4. **[src/agents/agent-runner.ts](file:///Users/sjarmak/amp-sales-workbench/src/agents/agent-runner.ts)**
   - Added 'risk-heuristics' to AgentName type
   - Added risk-heuristics case in runAgent() switch
   - Added agent metadata for risk-heuristics

5. **[src/agents/index.ts](file:///Users/sjarmak/amp-sales-workbench/src/agents/index.ts)**
   - Exported analyzeRiskHeuristics function
   - Added 'risk-heuristics' to AGENT_REGISTRY

6. **[package.json](file:///Users/sjarmak/amp-sales-workbench/package.json)**
   - Added `risks` script: `tsx scripts/test-risk-heuristics.ts`

## Risk Categories Implemented

### 1. **No Champion** (High Severity)
- **Detection**: No contacts with champion/influencer/sponsor role
- **Evidence**: Checks contact roles and signals.champions array
- **Mitigation**: Identify champion with budget authority, build relationship with decision maker

### 2. **Stale Next Meeting** (Medium-High Severity)
- **Detection**: No upcoming meetings OR next meeting >14 days out
- **Threshold**: 14 days
- **Evidence**: Calendar event dates
- **Mitigation**: Schedule interim check-in, send value-add content, ask about blockers

### 3. **Approaching Close Date** (Critical Severity)
- **Detection**: Deal closing in <30 days but still in early stage (Discovery, Qualification, Demo, Needs Analysis)
- **Threshold**: 30 days
- **Evidence**: Opportunity close dates and stages
- **Mitigation**: Reassess close date realism, push date or accelerate activities, identify what needs to happen

### 4. **Blockers Present** (High Severity)
- **Detection**: Keywords in signals.risks or call summaries: blocker, blocked, obstacle, red flag, concern, issue, problem, roadblock
- **Detection**: Negative/concerned sentiment in recent calls
- **Evidence**: Risk entries, call summaries with negative keywords/sentiment
- **Mitigation**: Address blockers immediately, escalate to senior stakeholders, document mitigation plan

### 5. **Low Engagement** (Medium Severity)
- **Detection**: No recent calls OR last call >21 days ago
- **Threshold**: 21 days
- **Evidence**: Call history dates
- **Mitigation**: Schedule catch-up call, send personalized message, assess if deal is still active

### 6. **Competitive Threats** (Medium Severity)
- **Detection**: Keywords in signals.competitiveMentions or call transcripts: competitor, alternative, versus, comparing, evaluating
- **Evidence**: Competitor mentions, competitive discussion topics
- **Mitigation**: Prepare competitive battle card, ask what they're comparing against, emphasize unique value

### 7. **Budget Unclear** (Medium Severity)
- **Detection**: No deal amount set, budget/pricing objections, stalled budget discussions in calls
- **Keywords**: budget, pricing, cost, price, expensive, affordability + waiting, pending, unclear, tbd, not sure
- **Evidence**: Missing opportunity amounts, budget objections, stalled pricing discussions
- **Mitigation**: Ask about allocated budget, discuss ROI/business case, identify budget controller

### 8. **Decision Process Stalled** (High Severity)
- **Detection**: Security/legal/procurement/compliance reviews mentioned as pending/delayed/stuck
- **Keywords**: security, legal, procurement, compliance, review, approval + pending, waiting, delayed, stuck, slow, hold
- **Evidence**: Stalled process mentions in calls, next actions, risks
- **Mitigation**: Identify approval gates and timeline, ask about steps to final approval, support reviews with docs, escalate if stuck

## Detection Logic

### Date-Based Risks
- **Stale Meeting**: Compares next meeting date to current date + 14 days
- **Approaching Close**: Compares close date to current date + 30 days AND checks if stage is early
- **Low Engagement**: Compares last call date to current date + 21 days

### Keyword-Based Risks
- **Blockers**: Searches signals.risks, call.summary, call.sentiment for blocker keywords
- **Competitive**: Searches signals.competitiveMentions, call.summary, call.topics for competitor keywords
- **Budget**: Searches opportunity.amount (null check), objections, call.summary for budget + stalled keywords
- **Decision Process**: Searches call.summary, nextActions, signals.risks for process + stalled keywords

### Relationship-Based Risks
- **No Champion**: Checks if signals.champions is empty AND no contacts have champion/influencer/sponsor role

## Output Format

### JSON (`risk-heuristics-YYYYMMDD.json`)
```json
{
  "noChampion": {
    "detected": true,
    "severity": "high",
    "message": "No champion or key influencer identified in this deal",
    "evidence": ["No contacts with champion/influencer/sponsor role", "No champions listed in signals"],
    "detectedAt": "2025-10-21T...",
    "mitigationSteps": ["Identify a champion...", "Build relationship...", "Ask: \"Who internally...\""]
  },
  ...
}
```

### Markdown (`risk-heuristics-YYYYMMDD.md`)
```markdown
# Risk Heuristics: Account Name
Generated: 2025-10-21T...

## Summary
- **Total Risks Detected**: 3
- **Critical**: 1
- **High**: 2
- **Medium**: 0
- **Low**: 0

## Detected Risks

### ðŸ”´ APPROACHING CLOSE DATE (CRITICAL)
**Message**: 1 opportunity(ies) closing soon but in early stage
**Evidence**:
- Enterprise Deal: Discovery, closes in 28 days
**Mitigation Steps**:
- Reassess close date - is it realistic given current stage?
- Push close date out or accelerate deal activities
...
```

## Usage

### CLI
```bash
npm run risks "Acme Corp"
```

### API
```bash
GET /api/accounts/acme-corp/risks
```

Returns latest risk analysis JSON or 404 if none exists.

### Web UI
Can be integrated into Insights tab or Deal Review section with risk badges and severity indicators.

## Integration Points

- **Consolidation Agent**: Risk heuristics can optionally be run during consolidation and added to `snapshot.riskHeuristics`
- **Deal Review**: Risk analysis can be referenced in deal health scoring
- **Digest**: High/Critical risks can be included in daily digest alerts
- **CRM Sync**: Risk flags could optionally be written back to Salesforce custom fields

## Future Enhancements

1. **Configurable Thresholds**: Allow users to adjust 14/21/30 day thresholds
2. **Custom Keywords**: Support custom keyword lists per org
3. **Severity Scoring**: Combine multiple risks into overall deal health score (0-100)
4. **Historical Trends**: Track risk changes over time (e.g., "Risk increased from Medium to High")
5. **Action Items**: Auto-generate next steps/tasks from mitigation recommendations
6. **Notifications**: Trigger Slack/email alerts when Critical risks detected
7. **Risk Weights**: Weight risks based on deal size, stage, industry
8. **ML Enhancement**: Use historical closed-won/closed-lost data to refine detection rules
